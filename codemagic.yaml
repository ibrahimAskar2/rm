workflows:
  android-build:
    name: Android Release Build
    max_build_duration: 60
    instance_type: mac_mini_m2
    environment:
      groups:
        - android_signing  # Ù„Ù…ÙØ§ØªÙŠØ­ ØªÙˆÙ‚ÙŠØ¹ Android ÙÙ‚Ø·
      flutter: "stable"  # Ø£Ùˆ Ø¥ØµØ¯Ø§Ø± Ù…Ø­Ø¯Ø¯ Ù…Ø«Ù„ "3.19.5"
      vars:
        PACKAGE_NAME: "com.ansar.ansar_team"

    scripts:
      # ----------------------
      # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø³Ø¨Ù‚Ø©
      # ----------------------
      - name: Project Setup
        script: |
          echo "=== ðŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ==="
          
          if [ ! -f "flutter_app/pubspec.yaml" ]; then
            echo "âŒ Ù…Ù„Ù pubspec.yaml ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
            exit 1
          fi
          
          cd flutter_app
          echo "âœ”ï¸ ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"

      # ----------------------
      # Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
      # ----------------------
      - name: Dependencies
        script: |
          echo "=== ðŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª ==="
          cd flutter_app
          
          flutter clean
          rm -rf android/.gradle  # ØªÙ†Ø¸ÙŠÙ Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
          flutter pub cache repair
          flutter pub get

      # ----------------------
      # Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¬ÙˆØ¯Ø©
      # ----------------------
      - name: Code Quality
        script: |
          echo "=== ðŸ”¬ ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø© ==="
          cd flutter_app
          
          flutter analyze --no-pub > analysis_report.txt
          flutter test --coverage > test_report.txt

      # ----------------------
      # Ø¨Ù†Ø§Ø¡ APK
      # ----------------------
      - name: Build APK
        script: |
          echo "=== ðŸ› ï¸ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ==="
          cd flutter_app
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù local.properties ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
          echo "flutter.sdk=${FLUTTER_ROOT}" > android/local.properties
          echo "sdk.dir=${ANDROID_SDK_ROOT}" >> android/local.properties
          
          flutter build apk --release \
            --dart-define=APP_ENV=prod \
            --verbose \
            > build_report.txt

    # ----------------------
    # Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª
    # ----------------------
    artifacts:
      - flutter_app/build/app/outputs/flutter-apk/app-release.apk
      - flutter_app/analysis_report.txt
      - flutter_app/test_report.txt
      - flutter_app/build_report.txt

    # ----------------------
    # Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    # ----------------------
    publishing:
      email:
        recipients:
          - aallaannssaarr@gmail.com
